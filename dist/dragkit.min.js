!function(t,e){"undefined"!=typeof exports&&"undefined"!=typeof module?module.exports=e():"function"!=typeof define||"object"!=typeof define.amd&&"object"!=typeof define.cmd?t.dragkit=e():define(e)}(window,function(t){"use strict";function e(t,e,i,s){this.init(t,e,i,s)}function i(t,i,s){if(i&&!i.hasAttribute(a)){x.init(!0,document.body),k.init();var n=k.index();return i.setAttribute(a,n),k.set(new e(t,i,s,n))}}function s(t){delete k[t.opt.container.getAttribute(a)],t.destroy(),t=null}var n=14,r="dk-container",o="dk-start-container",a="data-dk-id",d="data-dk-node-info",h="dk-item",c="dk-animate-item",u="dk-dragdrop-item",l="dk-add-item",g="dk-delete-item",f="dk-cover-item",m="dk-placeholder-item",v="dk-item-content",p="dk-item-prompt-text",N="dk-delete-item-ico",D=function(){},y={className:"",maxNodeNum:4,nodeH:24,isCoverNode:!0,containerInHitScale:.6,containerOutHitScale:.6,coverNodeScale:.7,isShowPromptText:!1,padding:5,distance:5,editNode:D,addNode:D,deleteNode:D,onLoad:D,onClick:D},C={extend:function(t,e){if(!e)return t;var i={};for(var s in t)i[s]="undefined"!=typeof e[s]?e[s]:t[s];return i},clone:function(t){var e={};for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},throttle:function(t){var e=(new Date).getTime();this.throttle=function(t){return t-e>n&&(e=t,!0)},this.throttle(t)},checkHit:function(t,e,i,s){return t.x+t.w>e.x&&t.x<e.x+e.w&&t.y+t.h>e.y&&t.y<e.y+e.h},checkContainerHit:function(t,e,i,s,n){for(var r={x:n.pageX-t,y:n.pageY-e,w:i.clientWidth,h:i.clientHeight},o=k.arr,a=0;a<o.length;a++){var d=o[a],h=E.getOffset(d.container),c={x:h.left,y:h.top,w:h.width,h:h.height};if(this.checkHit(c,r,s))return{isContainerHit:!0,currentDragkit:d,dragNodeCoord:r}}return{isContainerHit:!1,dragNodeCoord:r}},checkNodeHit:function(t,e,i){if(t&&t.length>0)for(var s=0;s<t.length;s++){var n=t[s],r=parseInt(i.nodeH*i.coverNodeScale);if(n.innerY<e.y&&e.y<n.innerY+r)return{isNodeHit:!0,coveredNode:n}}return{isNodeHit:!1,coveredNode:void 0}},getDom2Dragkit:function(t){var e=E.searchUp(t,r);if(e)return k.get(e.getAttribute(a))}},k={init:function(){this.arr||(this.arr=[])},get:function(t){return this.arr[t-1]},set:function(t){return this.arr.push(t),t},index:function(){return this.arr.length+1}},E={setContainerParam:function(t,e,i){var s=i.querySelector("."+p),n=e.length*(t.nodeH+t.padding);e.length<t.maxNodeNum&&t.isShowPromptText?(n+=t.nodeH,s.style.cssText="display:block;"):s.style.cssText="display:none;",i.style.cssText="height:"+n+"px"},searchUp:function(t,e){if(t&&t!==document.body&&t!==document)return t.classList.contains(e)?t:this.searchUp(t.parentNode,e)},getOffset:function(t,e,i){return i?(e=e||{top:0,left:0},null===t||t===i?e:(e.top+=t.offsetTop,e.left+=t.offsetLeft,this.getOffset(t.offsetParent,e,i))):t.getBoundingClientRect()},init:function(t,e,i){var s=this,n={},r=document.createDocumentFragment();return t&&t.length>0&&(t.forEach(function(t,e){var i=s.create(t);n[t.id]=i,r.appendChild(i)}),this.setContainerParam(e,t,i),i.appendChild(r)),n},create:function(t,e){var i=document.createElement("div"),s=document.createElement("div");return i.className=v,i.innerHTML=t.text,s.appendChild(i),s.className=e||h+" "+c,s.setAttribute(a,t.id||""),s.style.cssText=this.setStyleTop(t.innerY),t.id&&this.appendDelIco(s,t.id),s},remove:function(t,e,i){i=i||h;var s=e?"["+a+'="'+(e||"")+'"]':"",n=t.querySelector("div."+i+s);n&&t.removeChild(n)},render:function(t,e,i,s){for(var n in i)if(i.hasOwnProperty(n)){var r=i[n];if(!r.classList.contains(u)){var o=e.filter(function(t){return t.id===r.getAttribute(a)})[0];r.style.cssText=this.setStyleTop(o.innerY)}}this.setContainerParam(t,e,s)},setStyleTop:function(t){return";top:"+t+"px;"},appendDelIco:function(t,e){var i=document.createElement("div");i.className=N,i.innerHTML="âœ•",i.setAttribute(a,e),t.appendChild(i)}},x={init:function(t){this.isbind||(this.isbind=t,this.globalUnbind(),this.globalBind())},globalBind:function(){document.addEventListener("mousedown",this.mouseDown,!1),document.addEventListener("mousemove",this.mouseMove,!1),document.addEventListener("mouseup",this.mouseUp,!1),document.addEventListener("click",this.click,!0),this.isbind=!0},globalUnbind:function(){document.removeEventListener("mousedown",this.mouseDown,!1),document.removeEventListener("mousemove",this.mouseMove,!1),document.removeEventListener("mouseup",this.mouseUp,!1),document.removeEventListener("click",this.click,!0),this.isbind=!1},mouseDown:function(t){t.target.classList.contains(N)?this.isDragDeleteNode=!0:(this.distanceX=t.pageX,this.distanceY=t.pageY,this.distance=b.dragStart(t))},mouseMove:function(t){b.drag(t)},mouseUp:function(t){if(this.isDragDeleteNode){var e=t.target,i=C.getDom2Dragkit(e);i&&(i.remove({id:e.getAttribute(a)}),i.layout(),this.isDragDeleteNode=void 0)}else b.dragEnd(t)},click:function(t){if(this.distance){var e=Math.abs(t.pageX-this.distanceX||0),i=Math.abs(t.pageY-this.distanceY||0);(this.distance<=e||this.distance<=i)&&(t.stopPropagation(),this.distance=void 0,this.distanceX=void 0,this.distanceY=void 0)}}},b={state:{},dragStart:function(t){var e=E.searchUp(t.target,h);if(e){if(this.isDrag=!0,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,!e.classList.contains(l)){this.state.inside=!0;var i=C.getDom2Dragkit(e);return i.container.classList.add(o),this.startDragkit=this.dragkit=i,this.copyDragElement(t,!1,e,i),i.opt.distance}this.state.isDragAddNode=!0,this.state.inside=!1,this.copyDragElement(t,!0,e)}},copyDragElement:function(t,e,i,s){if(e)this.dragNode=JSON.parse(i.getAttribute(d)),this.dragNode&&(this.dragElement=E.create(this.dragNode),this.dragElement.className=h+" "+l+" "+u);else{var n=i.getAttribute(a);s.elements[n].classList.add(m),this.dragNode=C.clone(s.query(n)),this.dragElement=s.elements[n].cloneNode(!0),this.dragElement.className=h+" "+u}this.moveDragElement(t),document.body.appendChild(this.dragElement)},moveDragElement:function(t){var e=t.pageX-this.offsetX,i=t.pageY-this.offsetY;this.dragElement&&(this.dragElement.style.cssText="top:"+i+"px;left:"+e+"px;")},drag:function(t){if((this.isDrag||this.dragNode)&&C.throttle((new Date).getTime())){this.moveDragElement(t);var e=C.checkContainerHit(this.offsetX,this.offsetY,this.dragElement,this.state,t);this.dragNodeCoord=e.dragNodeCoord,e.isContainerHit?(this.state.inside||(this.dragEnterContainer(e.currentDragkit),this.dragkit=e.currentDragkit,this.state.inside=!0),this.dragStayContainer(this.dragkit)):this.state.inside&&(this.dragLeaveContainer(this.dragkit),this.state.inside=!1)}},dragEnterContainer:function(t){this.state.isDragDeleteNode=!1,this.dragElement.classList.remove(g),this.state.isDragCrossNode=this.startDragkit&&this.startDragkit!==t,(this.state.isDragAddNode||this.state.isDragCrossNode)&&t.data.length<t.opt.maxNodeNum&&(t.add(this.dragNode,this.dragElement),t.elements[this.dragNode.id].classList.add(m),this.state.isPlaceHolderNode=!0),console.log("enter")},dragStayContainer:function(t){if(t.opt.isCoverNode&&t.data.length>=t.opt.maxNodeNum&&!this.state.isPlaceHolderNode&&(this.state.isDragAddNode||this.state.isDragCrossNode)){var e=E.getOffset(t.container).top,i=this.dragNodeCoord.y-e,s=C.checkNodeHit(t.data,{y:i},t.opt);if(!s.isNodeHit)return this.state.isDragCoverNode=!1,this.setCoverNodeStyle(t);this.state.isDragCoverNode=!0,this.dragCoveredNode=s.coveredNode,this.setCoverNodeStyle(t,this.dragCoveredNode)}this.applyLayout(this.dragNode,t)},dragLeaveContainer:function(t){return this.state.isDragAddNode||(this.state.isDragDeleteNode=!0,this.dragElement.classList.add(g)),(this.state.isDragAddNode||this.state.isDragCrossNode)&&(t.remove(this.dragNode),t.layout(),this.state.isPlaceHolderNode=!1),this.state.isDragCoverNode?(this.state.isDragCoverNode=!1,this.setCoverNodeStyle(t)):void console.log("leave")},applyLayout:function(t,e){var i=E.getOffset(e.container).top;e.layout(t,this.dragNodeCoord.y-i)},setCoverNodeStyle:function(t,e){var i=t.elements;for(var s in i)i.hasOwnProperty(s)&&(e&&i[s].getAttribute(a)===e.id?i[s].classList.add(f):i[s].classList.remove(f))},dragEnd:function(t){if(this.isDrag){this.state.isDragDeleteNode&&(this.dragkit.remove(this.dragNode),this.dragkit.layout());var e=this.dragNode&&this.dragNode.id,i=e&&this.dragkit.elements[e];i&&i.classList.remove(m),this.state.isDragCoverNode&&(this.dragCoveredNode&&this.dragkit.cover(this.dragCoveredNode,this.dragNode),delete this.dragCoveredNode),this.state.isDragCrossNode&&(this.startDragkit.remove(this.dragNode),this.startDragkit.layout()),E.remove(document.body,this.state.isDragAddNode?"":e,u)}this.startDragkit&&this.startDragkit.container.classList.remove(o),this.state={},delete this.isDrag,delete this.dragkit,delete this.startDragkit,delete this.dragNode,delete this.dragElement,delete this.offsetX,delete this.offsetY,delete this.dragNodeCoord}};return e.prototype={constructor:e,init:function(t,e,i,s){this.number=s,this.autoIncrement=0,this.opt=C.extend(y,t),this.container=e,this.originData=i,this.data=this.setData(i),this.elements=E.init(this.data,this.opt,this.container)},destroy:function(){},setData:function(t){var e=[],i=this.opt,s=this;return t.forEach(function(t,n){e[n]={id:s.number+"-"+ ++s.autoIncrement,text:t.text,innerY:n*(i.nodeH+i.padding)}}),e},resetData:function(){var t=this.opt;return this.data.forEach(function(e,i){e.innerY=i*(t.nodeH+t.padding)}),this.data},layout:function(t,e){var i=t&&this.query(t.id);i&&(i.innerY=e),this.data.sort(function(t,e){return t.innerY-e.innerY}),this.resetData(),E.render(this.opt,this.data,this.elements,this.container)},query:function(t){if(t)return this.data.filter(function(e){return e.id===t})[0]},add:function(t){var e=this.opt;t.id=t.id||this.number+"-"+ ++this.autoIncrement,t.innerY=void 0!==t.innerY?t.innerY:this.data.length*(e.nodeH+e.padding),this.data.push(t);var i=E.create(t);return this.elements[t.id]=i,this.container.appendChild(i),t},remove:function(t){t&&t.id&&(this.data.forEach(function(e,i,s){e.id===t.id&&s.splice(i,1)}),delete this.elements[t.id],E.remove(this.container,t.id))},update:function(t,e){},cover:function(t,e){e.innerY=t.innerY,this.remove(t),this.add(e),this.layout()},showPromptText:function(t,e){this.opt.isShowPromptText=t&&e||!1,E.setContainerParam(this.opt,this.data,this.container)}},t={version:"1.1.0",instance:i,destroy:s}});