!function(t,e){"undefined"!=typeof exports&&"undefined"!=typeof module?module.exports=e():"function"!=typeof define||"object"!=typeof define.amd&&"object"!=typeof define.cmd?t.dragkit=e():define(e)}(window,function(t){"use strict";function e(t,e,i,s){this.init(t,e,i,s)}function i(t,i,s){if(i&&!i.hasAttribute(a)){L.init(!0,document.body),E.init();var n=E.index();return i.setAttribute(a,n),E.set(new e(t,i,s,n))}}function s(t){delete E[t.opt.container.getAttribute(a)],t.destroy(),t=null}var n=14,r="dk-container",o="dk-start-container",a="data-dk-id",d="data-dk-text",h="data-dk-node-info",c="dk-item",l="dk-hide-item",u="dk-animate-item",g="dk-dragdrop-item",f="dk-add-item",m="dk-delete-item",p="dk-cover-item",v="dk-placeholder-item",N="dk-item-content",y="dk-item-prompt-text",D="dk-delete-item-ico",k=function(){},C={className:"",showFieldName:"text",maxNodeNum:4,nodeH:24,isCoverNode:!0,hitScale:.6,coverNodeScale:.7,isShowPromptText:!1,padding:5,distance:5,onCoverNode:k,onAddNode:k,onDeleteNode:k,onLoad:k},x={extend:function(t,e){if(!e)return t;var i={};for(var s in t)i[s]="undefined"!=typeof e[s]?e[s]:t[s];return i},clone:function(t){var e={};for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},throttle:function(t){var e=(new Date).getTime();this.throttle=function(t){return t-e>n&&(e=t,!0)},this.throttle(t)},getDom2Dragkit:function(t){var e=b.searchUp(t,r);if(e)return E.get(e.getAttribute(a))}},w={checkHit:function(t,e,i,s){var n={x:e.x,y:e.y,w:e.w,h:e.h,xw:e.x+e.w,yh:e.y+e.h,area:e.w*e.h},r={x:t.x,y:t.y,w:t.w,h:t.h,xw:t.x+t.w,yh:t.y+t.h},o=!1,s=i?1-s:s;if(r.xw>n.x&&r.x<n.xw&&r.yh>n.y&&r.y<n.yh){var a=n.w,d=n.h;n.x<r.x&&(a=n.xw-r.x),r.xw<n.xw&&(a=r.xw-n.x),n.y<r.y&&(d=n.yh-r.y),r.yh<n.yh&&(d=r.yh-n.y),o=a*d/n.area>=s}return o},checkContainerHit:function(t,e,i){for(var s=E.arr,n=0;n<s.length;n++){var r=s[n],o=b.getOffset(r.container),a={x:o.left,y:o.top,w:o.width,h:o.height};if(this.checkHit(a,t,e,r.opt.hitScale))return{isContainerHit:!0,currentDragkit:r,dragNodeCoord:t}}return{isContainerHit:!1,dragNodeCoord:t}},checkNodeHit:function(t,e,i,s,n){if(Array.isArray(e))for(var r=b.getOffset(t),o={x:s.x-r.left,y:s.y-r.top,w:s.w,h:s.h},a=0;a<e.length;a++){var d=e[a],h={x:0,y:d.innerY,w:i[d.id].clientWidth,h:i[d.id].clientHeight};if(this.checkHit(h,o,void 0,n))return{isNodeHit:!0,coveredNode:d}}return{isNodeHit:!1,coveredNode:void 0}}},E={init:function(){this.arr||(this.arr=[])},get:function(t){return this.arr[t-1]},set:function(t){return this.arr.push(t),t},index:function(){return this.arr.length+1}},b={dom2obj:function(t,e){var i=0,s=[],n=e.opt,r=t.children;e.elements={};for(var o=0,h=r.length;o<h;o++){var l=r[o];if(l.classList.contains(c)){var u=i++,g=l.getAttribute(a);s[u]={id:g},s[u][n.showFieldName]=l.getAttribute(d),e.elements[g]=l}}return s},setContainerParam:function(t,e,i){var s=i.querySelector("."+y),n=e.length*(t.nodeH+t.padding);e.length<t.maxNodeNum&&t.isShowPromptText?(n+=t.nodeH,s.style.cssText="display:block;"):s.style.cssText="display:none;",i.style.cssText="height:"+n+"px"},searchUp:function(t,e){if(t&&t!==document.body&&t!==document)return t.classList.contains(e)?t:this.searchUp(t.parentNode,e)},getOffset:function(t,e,i){return i?(e=e||{top:0,left:0},null===t||t===i?e:(e.top+=t.offsetTop,e.left+=t.offsetLeft,this.getOffset(t.offsetParent,e,i))):t.getBoundingClientRect()},init:function(t,e,i){var s=this,n={},r=document.createDocumentFragment();return t&&t.length>0&&(t.forEach(function(t,i){var o=s.create(t,e);n[t.id]=o,r.appendChild(o)}),this.setContainerParam(e,t,i),i.appendChild(r)),n},create:function(t,e,i){var s=document.createElement("div"),n=document.createElement("div");return s.className=N,s.innerHTML=t[e&&e.showFieldName]||"",n.appendChild(s),n.className=i||c+" "+u,n.setAttribute(a,t.id||""),n.style.cssText=this.setStyleTop(t.innerY),t.id&&this.appendDelIco(n,t.id),n},update:function(t,e,i,s){if(t){var n=e.querySelector("."+N);return n.innerHTML=t[i.showFieldName]||"",e.className=s||c+" "+u,e.setAttribute(a,t.id||""),e.style.cssText=this.setStyleTop(t.innerY),t.id&&this.appendDelIco(e,t.id),e}},show:function(t){t.classList.remove(l)},hide:function(t){t.classList.add(l)},remove:function(t,e,i){i=i||c;var s=e?"["+a+'="'+(e||"")+'"]':"",n=t.querySelector("div."+i+s);n&&t.removeChild(n)},render:function(t,e,i,s){for(var n in i)if(i.hasOwnProperty(n)){var r=i[n];if(!r.classList.contains(g)){var o=e.filter(function(t){return t.id===r.getAttribute(a)})[0];r.style.cssText=this.setStyleTop(o.innerY)}}this.setContainerParam(t,e,s)},setStyleTop:function(t){return";top:"+t+"px;"},appendDelIco:function(t,e){var i=document.createElement("div");i.className=D,i.innerHTML="âœ•",i.setAttribute(a,e),t.appendChild(i)}},L={init:function(t){this.isbind||(this.isbind=t,this.globalUnbind(),this.globalBind(),H.init())},globalBind:function(){document.addEventListener("mousedown",this.mouseDown,!1),document.addEventListener("mousemove",this.mouseMove,!1),document.addEventListener("mouseup",this.mouseUp,!1),document.addEventListener("click",this.click,!0),this.isbind=!0},globalUnbind:function(){document.removeEventListener("mousedown",this.mouseDown,!1),document.removeEventListener("mousemove",this.mouseMove,!1),document.removeEventListener("mouseup",this.mouseUp,!1),document.removeEventListener("click",this.click,!0),this.isbind=!1},mouseDown:function(t){if(!t.target.classList.contains(D)){var e=b.searchUp(t.target,c);e&&(L.distanceX=t.pageX,L.distanceY=t.pageY,H.dragStart(t,e,function(t){L.distance=t}))}},mouseMove:function(t){H.drag(t)},mouseUp:function(t){H.dragEnd(t)},click:function(t){if(t.target.classList.contains(D)){var e=x.getDom2Dragkit(t.target),i=t.target.getAttribute(a);if(!e)return;e.remove({id:i}),e.layout()}else{var s=Math.abs(t.pageX-L.distanceX||0),n=Math.abs(t.pageY-L.distanceY||0);(L.distance<=s||L.distance<=n)&&(t.stopPropagation(),delete L.distance,delete L.distanceX,delete L.distanceY)}}},H={state:{},init:function(){this.dragNode=null,this.dragElement=b.create({},{},l),document.body.appendChild(this.dragElement)},dragStart:function(t,e,i){if(this.isDrag=!0,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,e.classList.contains(f))this.state.isDragAddNode=!0,this.state.inside=!1,this.copyDragElement(e);else{this.state.inside=!0;var s=x.getDom2Dragkit(e);s.container.classList.add(o),this.startDragkit=this.dragkit=s,this.copyDragElement(e),i&&i(s.opt.distance)}this.moveDragElement(t)},copyDragElement:function(t){var e;if(this.state.isDragAddNode)e=c+" "+f+" "+g,this.dragNode=JSON.parse(t.getAttribute(h));else{e=c+" "+g;var i=t.getAttribute(a);this.dragkit.elements[i].classList.add(v),this.dragNode=x.clone(this.dragkit.query(i))}var s=this.dragkit?this.dragkit.opt:{showFieldName:C.showFieldName};b.update(this.dragNode,this.dragElement,s,e),b.show(this.dragElement)},moveDragElement:function(t){var e=t.pageX-this.offsetX,i=t.pageY-this.offsetY;this.dragElement&&(this.dragElement.style.cssText="top:"+i+"px;left:"+e+"px;")},drag:function(t){if((this.isDrag||this.dragNode)&&x.throttle((new Date).getTime())){this.moveDragElement(t);var e=this.getDragElementCoord(t),i=w.checkContainerHit(e,this.state.inside);this.dragNodeCoord=i.dragNodeCoord,i.isContainerHit?(this.state.inside||(this.dragEnterContainer(i.currentDragkit),this.dragkit=i.currentDragkit,this.state.inside=!0),this.dragStayContainer(this.dragkit)):this.state.inside&&(this.dragLeaveContainer(this.dragkit),this.state.inside=!1)}},dragEnterContainer:function(t){this.state.isDragDeleteNode=!1,this.dragElement.classList.remove(m),this.state.isDragCrossNode=this.startDragkit&&this.startDragkit!==t,(this.state.isDragAddNode||this.state.isDragCrossNode)&&t.data.length<t.opt.maxNodeNum&&(t.add(this.dragNode,this.dragElement),t.elements[this.dragNode.id].classList.add(v),this.state.isPlaceHolderNode=!0)},dragStayContainer:function(t){if(t.opt.isCoverNode&&t.data.length>=t.opt.maxNodeNum&&!this.state.isPlaceHolderNode&&(this.state.isDragAddNode||this.state.isDragCrossNode)){var e=this.getDragElementCoord(event),i=w.checkNodeHit(t.container,t.data,t.elements,e,t.opt.coverNodeScale);if(!i.isNodeHit)return this.state.isDragCoverNode=!1,this.setCoverNodeStyle(t);this.state.isDragCoverNode=!0,this.dragCoveredNode=i.coveredNode,this.setCoverNodeStyle(t,this.dragCoveredNode)}this.applyLayout(this.dragNode,t)},dragLeaveContainer:function(t){if(this.state.isDragAddNode||(this.state.isDragDeleteNode=!0,this.dragElement.classList.add(m)),(this.state.isDragAddNode||this.state.isDragCrossNode)&&(t.remove(this.dragNode),t.layout(),this.state.isPlaceHolderNode=!1),this.state.isDragCoverNode)return this.state.isDragCoverNode=!1,this.setCoverNodeStyle(t)},applyLayout:function(t,e){var i=b.getOffset(e.container).top;e.layout(t,this.dragNodeCoord.y-i)},setCoverNodeStyle:function(t,e){var i=t.elements;for(var s in i)i.hasOwnProperty(s)&&(e&&i[s].getAttribute(a)===e.id?i[s].classList.add(p):i[s].classList.remove(p))},getDragElementCoord:function(t){return{x:t.pageX-this.offsetX,y:t.pageY-this.offsetY,w:this.dragElement.clientWidth,h:this.dragElement.clientHeight}},dragEnd:function(t){if(this.isDrag){this.state.isDragDeleteNode&&(this.dragkit.remove(this.dragNode),this.dragkit.layout());var e=this.dragNode&&this.dragNode.id,i=e&&this.dragkit.elements[e];i&&i.classList.remove(v),this.state.isDragCoverNode&&(this.dragCoveredNode&&this.dragkit.cover(this.dragCoveredNode,this.dragNode),delete this.dragCoveredNode),this.state.isDragCrossNode&&(this.startDragkit.remove(this.dragNode),this.startDragkit.layout()),b.hide(this.dragElement),this.dragkit&&this.dragkit.opt.onLoad&&this.dragkit.opt.onLoad(this.dragkit)}this.startDragkit&&this.startDragkit.container.classList.remove(o),this.state={},delete this.isDrag,delete this.dragkit,delete this.startDragkit,delete this.dragNode,delete this.offsetX,delete this.offsetY,delete this.dragNodeCoord}};return e.prototype={constructor:e,init:function(t,e,i,s){if(this.number=s,this.autoIncrement=0,this.opt=x.extend(C,t),this.container=e,i)this.originData=i,this.data=this.setData(i),this.elements=b.init(this.data,this.opt,this.container);else{var n=b.dom2obj(e,this);n&&n.length>0&&(this.data=this.setData(n),b.render(this.opt,this.data,this.elements,this.container))}},destroy:function(){},setData:function(t){var e=[],i=this.opt,s=this;return t.forEach(function(t,n){e[n]={id:s.number+"-"+ ++s.autoIncrement,innerY:n*(i.nodeH+i.padding)},e[n][i.showFieldName]=t[i.showFieldName]}),e},resetData:function(){var t=this.opt;return this.data.forEach(function(e,i){e.innerY=i*(t.nodeH+t.padding)}),this.data},layout:function(t,e){var i=t&&this.query(t.id);i&&(i.innerY=e),this.data.sort(function(t,e){return t.innerY-e.innerY}),this.resetData(),b.render(this.opt,this.data,this.elements,this.container)},query:function(t){if(t)return this.data.filter(function(e){return e.id===t})[0]},add:function(t){var e=this.opt;t.id=t.id||this.number+"-"+ ++this.autoIncrement,t.innerY=void 0!==t.innerY?t.innerY:this.data.length*(e.nodeH+e.padding),this.data.push(t);var i=b.create(t,e);return this.elements[t.id]=i,this.container.appendChild(i),this.opt.onAddNode&&this.opt.onAddNode(this,t),t},remove:function(t){var e=x.clone(t);t&&t.id&&(this.data.forEach(function(e,i,s){e.id===t.id&&s.splice(i,1)}),delete this.elements[t.id],b.remove(this.container,t.id),this.opt.onDeleteNode&&this.opt.onDeleteNode(this,e))},update:function(t,e){},cover:function(t,e){e.innerY=t.innerY,this.remove(t),this.add(e),this.layout(),this.opt.onCoverNode&&this.opt.onCoverNode(this)},showPromptText:function(t,e){this.opt.isShowPromptText=t&&e||!1,b.setContainerParam(this.opt,this.data,this.container)}},t={version:"1.1.0",instance:i,destroy:s}});